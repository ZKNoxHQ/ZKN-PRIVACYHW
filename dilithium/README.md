# Dilithium MLDSA application for Ledger Flex

## SIDELOADING THE APP

Loading the app requires a few dependencies we install in a virtual environment:
```
python3 -m virtualenv ledger
# Install Ledgerblue (tool to load the app)
ledger/bin/python3 -m pip install ledgerblue
```

In order to load the app, use the following command:
```
# Load the app on the flex.
ledger/bin/python3 -m ledgerblue.runScript --scp --fileName flex/app.apdu --elfFile flex/app.elf
```

## SIGNING

In order to sign a message, the file `dilithium-apdu.js` defines all the needed APDUs (make sure the Ledger Flex is connected and that the app MLDSA is open):
```
npm install @ledgerhq/hw-transport-node-hid
node dilithium-apdu.js <message_in_hex>
```
This computes the following apdus:
1. `apdu_insecure_seed`: Derive an (insecure) seed stored in RAM, unique per Ledger (NB: in the future, this seed will be directly taken from the secure element but we do not have access to it for this proof of concept),
2. `apdu_dilithium_sign_init`: Compute the secret and public keys derived from the seed, and store the public key in RAM, 
3. `apdu_dilithium_sign_absorb`: Absorb the message by chunks using Dilithium signer (mainly, hash evaluations),
4. `apdu_dilithium_sign_core`: Compute the core algorithm of Dilithium signer (including NTTs), and store the signature in RAM
5. `apdu_dilithium_get_sig_chunk_i`: Get the chunks of the signature stored in RAM,
6. `apdu_dilithium_get_pk_chunk_i`: Get the chunks of the public key stored in RAM.


For a small message like `abcdef`, it outputs
```
Available devices: [ '/dev/hidraw1' ]
Connected to Ledger Device

Sending APDU (apdu_insecure_seed): E014000015058000002c80001f91800000000000000000000000

Sending APDU (apdu_dilithium_sign_init): e00f0000

Sending APDU (apdu_dilithium_sign_absorb_1): e00f010003abcdef

Sending APDU (apdu_dilithium_sign_core): e00f8000020210

========== RETRIEVING SIGNATURE ==========

Sending APDU (apdu_dilithium_get_sig_chunk_1): e01200ff00

Sending APDU (apdu_dilithium_get_sig_chunk_2): e01201ff00

Sending APDU (apdu_dilithium_get_sig_chunk_3): e01202ff00

Sending APDU (apdu_dilithium_get_sig_chunk_4): e01203ff00

Sending APDU (apdu_dilithium_get_sig_chunk_5): e01204ff00

Sending APDU (apdu_dilithium_get_sig_chunk_6): e01205ff00

Sending APDU (apdu_dilithium_get_sig_chunk_7): e01206ff00

Sending APDU (apdu_dilithium_get_sig_chunk_8): e01207ff00

Sending APDU (apdu_dilithium_get_sig_chunk_9): e01208ff00

Sending APDU (apdu_dilithium_get_sig_chunk_10): e012097d00

========== RETRIEVING PUBLIC KEY ==========

Sending APDU (apdu_dilithium_get_pk_chunk_1): e01300ff00

Sending APDU (apdu_dilithium_get_pk_chunk_2): e01301ff00

Sending APDU (apdu_dilithium_get_pk_chunk_3): e01302ff00

Sending APDU (apdu_dilithium_get_pk_chunk_4): e01303ff00

Sending APDU (apdu_dilithium_get_pk_chunk_5): e01304ff00

Sending APDU (apdu_dilithium_get_pk_chunk_6): e013052500

Connection closed
```
A file `data_dilithium.json` is created and contains the public key, the signature and the message being signed:
```
{
  "pk": "1e7cae8aab0f4d77d7203e0fc90ab264b7c5e615217f4ca6cd107aca33d353096997a1f667c7727d32e36d934df7457b314cccc7dc0f4420e2c8ffa21f06e58d438e31002335259c01b7393736412b7a1cc992c5c6fea2238680df40e59e561c83b1c950fa39a0c9f47dfea7c3f7d21cf02054b7ea5eba8bc4aa29f3b7800f4d1319edbfee389ce38bd2623d71be548d0be11ba74d5e95043160f03cb1a99d2734595aa592d03b04ac1fcd5ac2b34ff4b5318b8d16c5b9e68fe27eed1e0bdf465375f5a552adafd3bb881693fb10c6c2701186dee6709740dfecc47bbdc91d0b54bb142fcd6a131aa83d048fad4c52b48344e102f9e6da3514c00d8d4d96a6f707e709ee5e3d1a8dbb86a22d67beb8fb9b94833ffdfe123972de70bb00b1c680d1384b1e4147ac5a6c6f41071d4281cb49e3d387ff2512a501413953f118a63390a8b90203a659791af65ebee53aba8610f989e08aa91a0a5c237c64c2c9250198b7fe8830109ac0745f33faa6252f34855fbda62ee8d7f34c154ff900888b6f0a75948bac47136efad63b258d284799639d03afde740c4a6286ee60a7313a93d178496f2e31555151961106f6e1e262aff2c648bcc67c6efbe715ef6a796cf63a9ef7763be55e3b7368aa11110b803ef40429a127e101c4743ae9548852b923436da57e84e6ccf680d78205a2c6385670ba907bf2ffe3ae08f95a25c77e9f9ab373bf4a999498f673254dcca31402b99ee7df73919e3f8931b90078655d75843c8ba599971dbacffcc66ada587979ce9f7cbe9476cfb87f8e1a9562bb1e42d5f3487e9b177651a7117008766c164cd19f8b29f67ea22cb8eb4c70b6a64352b32d7b2bd01d22047949648cd4bef275c4d514063a6a965834a6cd21d2558bde0c8ae078c0c4374890fd0fd958dba3ef156135e24aedf67909dd1d9374f3240e3206954f435dfeb34ff7174694c8057fa5dcb39cffb0be14ef9fb20bc8185f2882e9c4a1d99bbf98373ead761a895d144a0d7a4b664e28945b22951dfe600fc19ea3c07f4257bf75fc103eaaaec8f6a408173d51cf3729b339a00f6a420762a82fb005e5281020910db933328e52dfc69c7781799328faa313dcf95849e5559bf8d3e1d0bf2fd5eed153ddb55ce13a028b10285fccb9c0d90cef8d950ed5b51f42f7fe0d6aa4835a2c64aa5bb65dbb02fb2ae4cd604f0a8ff82b8df8747012218557abfc85042071b1541f76a3846651676763ba430dfdb36f310350ef81d9032f4261ca2255bd8a4fdf76d78e4c8af2be1ba007644dc6efdb75f226c78961954236979018044ef9dae6e24444163cc4f7a38139c1e4d6bf125fcd899a8e7e8426f930c29d8dc9033bc31c386a4528e98626b47658e617eb225c5d016c857acfcf917f51af2139c7367ac9e49bfd9f9a27a250423aedfd086b546305b08e8ad2cf60d5e1add7de6338eb4ced7def9a8d41717ba7ad23fb33342ad4c38c0eba78c1d0adc5e3d1f3dd0c0d854f01068d2a7afb7734df1fd829d56c9737e433db9d41520bd7670555fe13d8f7e527f10b2e989d4adfe5d8b0a01bfc6a29cfdcd7390fe89105ef8b337afca0cb9ea17e61b655261a86d48e260cb425213755abb3c2b86dc6670fc464cf2a8ca0aaeea202cbe0046ea32638bf65dc3e33da699d8ffc99edf5210a93c2609f05714284fc460a92701af26cfe04d78b09fdad5dc25745adc0fa959603e579fd93cf1c35526a956cbec22e35eeaf2023e2daa209edb9244240761943de4ff525beccbe7cf51c9479a37bc0eeb2df90608501fa8f202c396733a10d3aab090b1e9d64982278e7ac7b70eb3058c5cb394fbd9b8151b408df88",
  "sig": "52cbfcc2588e9b05e5f1a8c677ac1129a9ec3f9fed62d9d76cf0910f33b54d2e5f5ed80183732ce1f30ce2803508a262b96d54c24fa22d33d3e74ab1c002b9ae90a95d4a6c618bb1d07d29c9b757b42cd77f234e0d94c4bb35081f793c7db67f60afc74bd9a9d3ad37edc3c081fae216e5341729190bad0c99a114d3bd9aed43ae982887fc2fe065ab98b695b196d40d26fd928a0bb22f6d6b254ff6e3acb497e8cae93ef9d84cd91403dd571ae8744e9ec73eab985b0856bd20b1cac5ce9dd98ce0fb5ed2f794e54e10d2b044f229743895725002c830cf98405f1b8e660edbeada72f528241ebd5a08d79aa17f2109a77e62ee8269c0152179f79a75741973300ad18c556de90e2557bfd7897918dc8a14a47ddc8543d17bab1fcd637550aced526058a566fd763ec63c914940dcd667af68240cd31d5dad66c76aef85fd4b3dabade166694f103d4157e1f41d3becb0527df0cdb8a87f30ef98dd469e10512b45286ed281e556472a440f28fde53d1dc67507f0beafcc1394473764d7e4a79ba20bd8d1b7d5fc702babb13820b163bf8173c1ff547c48ae6a9bf8544b52fc953321a1eebc6d33d737af8135d5acd75179ddfc4569d24cc7bff5b1294c9fcaef144d9e9f23edc68a5e4ffb86f303288188c9ca2fb67de11206299ec7076f317cf496c3872f044c67da48f7ddbec05ec63a91e282c1169b49e714039cba456a584675f1ac145e5914a838f6e287ce99870035cd711c7cf6694e36f23d3f034206dc7eddff122e86d60b143112014a4e2051c7f441c4dc852d3efcc0960b95fe70407258d7cf45d52c392bd19a67e903bb2cc9e73951f762f54512fcac301f8b9ad5d3bef035fae076293c6961aedf689c60664684845b8be5664350f7d5ed9ee4d9be0f4a43b884695e84b41866b74fbd98e4233954df7159b5b622dd563ffea997637f5a561c82433a865a871afce332af7c6476c028118b6fcb5cde100db9e88228b2a91a29524c82e279a2ea7120aef7e321a17b47e7e71c61baf513cdd416724c57411889fd692ffdf5bc01b72140934ecc02b5368d669cf79344ee33612d868d685b6fc91517859f0b9afb057c1baf2b8e2231e613070d5ca80474ba518f433c0c6e374b6944c955f2d682c1e0aec6711fe595ca335902ddd19cf6407299278c6e731c1653fd4231ae4b38ad0296657086523dfb95357c7602a87c9a1e27e78f4193a9c7cd98a6da26d7efe3bf7438cada2fd559f5c1c308cdfef7c0ac984e72ffdd6adecb21bfd9e277b943f147bf534e30e28f25d97fe98336f301e4c9e87e54d48f2f6a23244e218374363c8868824bf2cebbd249aff42c8ac23290c6211371c4256125bbef6d3af52847abb65cae5d698e706b72403f546bfe51b51e1d66bdfa17175d0811a871cd1e1e5d9809b92a93b69faa7fbb95673d0d6c020576c17e28e915cd3cd199efe6ef798ed8d173bf13f618437bb4bf11a385ce7be55c788ae46995fc132c0f38b3300f0346d61be9c9361e771c77a0cc97c2ea145b1eb97470d9bfe0f7fc32dad89086dd9ac643656fc06da83c6266aff9b96e379cb8794bc6bab158e5ffff49da7a487ef5897e31c0a541efa4085cfd18821ade427a0029f34661b7091d11090885e16ee264517326b6c3c563b195978b87fc4eb8b085e5441768e55e0960f460131563a36d0aeb8e7dfc7c2be59fd0f158f628fa2c26dc11728633b1b99660ef9b97185068c7bd38325bdceea4f78768011a59f9b58c7798fdf9663d362ac40407cde8d3c38b165e66f2691f616a64351231bde8af17cebc23ba0ea95eae5d94fa7eef73f4e0b4b5452d8f4e99e1edb8b8777457bcb7b2c87204e0d2f445961c1c78a509c4db863beae18d47035dd9ddd95c15ee705b6c2082e41766ddf8a620df0664600d842c56e071c94c144ae5e338c10941ae41c824ddbb73b2c207db7862d3c40ea679e0acff007d6b534003831ca2c771cd05437dd0324928f2929768ed8983d102abed0f52092ced74e42db7d850c067c26568a1e9612d29637cb46cf937e3ff51aa9495e2129d8e3f22ef539501234ce0eb27c5aaca8661969b9319455eec57eb25314699bed7ee6d1f0be4f0f4601116f663744eed3c3eb464e45d71680d45f96515a3c438c87f8fdb6e6e120132949b101b4b124ba9413a5ba0a4db27bc7bde78f3d1981671225c8823ed9cdd420c86465e787f66651c5548d61948fda2783f2bc2bcdd84db5c35ce2ff3c8a94ca2f724c78cb6d6534930125d378c68eea9ade36256f6ca3ebbd8ff5a0cb8ae269993088df3779dd2444571b7576eeffa8b97bc2dae9fa63bb2aea66411e2c2781fbb4184b8a95675f185032f6b231ca1e252da3dd83a08d8f11ed082e4317c08ad1b09009951febdb436e998916f947764e25a5aade1a8efdda11c959f521f37e82689f14fad9a591980d484fbf5cc8fc4bad1100f9934d0796b1b7e7c89992d91075e807e9b3d5c7ea4f1c1dc6641c93580bff5aee919736c6522ae58771b9c512c81bbd5913f87ca686fba13d9c38f82876d2e40d936996be98f3882131d8dea302c2341e12b0e48702bf3fd44043957fc59bbecc9aa45d20ade062a52e898f1295dd26654264c982d766986f19a85e0fd1ae5d98c912fe6fc509b30a7f8ae8be151e62960b1d0e42e8e926441c20402047dfe0432fa1934de716d00ba81182b654860a63dc1e370c21564252058b5950ec0ebc0487cabb557ac9fcbc5418ef471046ad15d893ee407133c111b6557bbdb2d16ec3353625f39b855b087b7a310f8f3ab5645fbabdf45c046da08effcea7f9bb7f490ba34eff18342d9b0a208795b175e3eaf287065119bdcf0cfa6e1ebd3620fd289c2a7f00b4c434e2c5ac0d4f1c37087d486ab20a3261db963482279d7785f46d4769f758dd69655f3734937292dfae8c1383569d4c10920a5c68e1ed5b12790616d5b41eca04c80b8897e6616b411eee8d36e2712b3d7967b78134e17f58fedccb709abef6d7e28e4a4c32335e9ab164cea85518920f410c12875e50567779a4cbe91ae1b0fc218ff70f68513fbf90b5ecacb972040b55aaa611404eaf63becf51e1f79d27ee187cf2604e600c1b9cc62f0430e07a6f43148677efd6bea700e12cdb7d199abc38bcebb285066be097af37a28a721d9c2f0110cc83ef351837993c01d06dd9ba9419edc7532776bac341d1d45111c6083e495e4c61511396a542dbe5f98cbde53358008558be49eb8b1ffcfdf876e04b3bbaaa78cf6cf972d8aac33ff0b9833368d918f5d0314316468698c939eb3e1fc05212f4e5876868d95c0c3f3f41213202d2f323b5d5f6b84959ba0cad5e2f401161921414685878d97a4a6a7bfdff1f6f7fc0000000000000000000000000000000000000c192b3e",
  "msg": "abcdef"
}
```