# Dilithium MLDSAETH application for Ledger Flex

## SIDELOADING THE APP

Loading the app requires a few dependencies we install in a virtual environment:
```
python3 -m virtualenv ledger
# Install Ledgerblue (tool to load the app)
ledger/bin/python3 -m pip install ledgerblue
```

In order to load the app, use the following command:
```
# Load the app on the flex.
ledger/bin/python3 -m ledgerblue.runScript --scp --fileName flex/app.apdu --elfFile flex/app.elf
```

## SIGNING

In order to sign a message, the file `ethdilithium-apdu.js` defines all the needed APDUs (make sure the Ledger Flex is connected and that the app MLDSAETH is open):
```
npm install @ledgerhq/hw-transport-node-hid
node ethdilithium-apdu.js <message_in_hex>
```
This computes the following apdus:
1. `apdu_insecure_seed`: Derive an (insecure) seed stored in RAM, unique per Ledger (NB: in the future, this seed will be directly taken from the secure element but we do not have access to it for this proof of concept),
2. `apdu_dilithium_sign_init`: Compute the secret and public keys derived from the seed, and store the public key in RAM, 
3. `apdu_dilithium_sign_absorb`: Absorb the message by chunks using Dilithium signer (mainly, hash evaluations),
4. `apdu_dilithium_sign_core`: Compute the core algorithm of Dilithium signer (including NTTs), and store the signature in RAM
5. `apdu_dilithium_get_sig_chunk_i`: Get the chunks of the signature stored in RAM,
6. `apdu_dilithium_get_pk_chunk_i`: Get the chunks of the public key stored in RAM.


For a small message like `abcdef`, it outputs
```
Available devices: [ '/dev/hidraw1' ]
Connected to Ledger Device

Sending APDU (apdu_insecure_seed): E014000015058000002c80001f91800000000000000000000000

Sending APDU (apdu_dilithium_sign_init): e00f0000

Sending APDU (apdu_dilithium_sign_absorb_1): e00f010003abcdef

Sending APDU (apdu_dilithium_sign_core): e00f8000020210

========== RETRIEVING SIGNATURE ==========

Sending APDU (apdu_dilithium_get_sig_chunk_1): e01200ff00

Sending APDU (apdu_dilithium_get_sig_chunk_2): e01201ff00

Sending APDU (apdu_dilithium_get_sig_chunk_3): e01202ff00

Sending APDU (apdu_dilithium_get_sig_chunk_4): e01203ff00

Sending APDU (apdu_dilithium_get_sig_chunk_5): e01204ff00

Sending APDU (apdu_dilithium_get_sig_chunk_6): e01205ff00

Sending APDU (apdu_dilithium_get_sig_chunk_7): e01206ff00

Sending APDU (apdu_dilithium_get_sig_chunk_8): e01207ff00

Sending APDU (apdu_dilithium_get_sig_chunk_9): e01208ff00

Sending APDU (apdu_dilithium_get_sig_chunk_10): e012097d00

========== RETRIEVING PUBLIC KEY ==========

Sending APDU (apdu_dilithium_get_pk_chunk_1): e01300ff00

Sending APDU (apdu_dilithium_get_pk_chunk_2): e01301ff00

Sending APDU (apdu_dilithium_get_pk_chunk_3): e01302ff00

Sending APDU (apdu_dilithium_get_pk_chunk_4): e01303ff00

Sending APDU (apdu_dilithium_get_pk_chunk_5): e01304ff00

Sending APDU (apdu_dilithium_get_pk_chunk_6): e013052500

Connection closed
```
A file `data_ethdilithium.json` is created and contains the public key, the signature and the message being signed:
```
{
  "pk": "2370310931e5e9ed58fbf7907c583133875edd3217634efdb51e4270f5633cf4ff0c7de184cd7de086440856a299387afc13f78500d24dfce196db4fc3492a99ce0cff2236dad0e07ae7a9094780d30ee79b4e5c37b02f6d0c17f33bcc86865c08c83e6cf9da40d8c3d4d03763cf1f16d7bfaefa7370b47d0ce8e25dd84dcc16889eb6dad6f0c992ade7ceddbffd74e7976f71a5f3117702f8d6216720e0f641b9e0b7d6f318c9d0a5af85e90fac53e0625c7e73ed8b1900ad8026bb6e770015570514f39d9489875f706727f3c74bed68ca2ff43a9fa8b969ec2031d6df8509fa721fdb74c86580db84533e5a7c166d1d12942a926de480e3f4326147c71459c6c0cc9c1af79ea587aa9d544562a6a1647c759238c038ae0e438826bc0ac970816656fd7a93705abfdc34669090573b46558812df4f7e3391d1b30e980d9ff3d72a9ebcde7fecd6921fc2f530ce679435d57da988af01a08b4ffcb8ecbb7d542ed49cb9909ccc507c96b2e8355b571caad2f1539a773b35807cf54e3c49dc391a0a03ca49cbf9b5f746d6a5ef87e616b12b15865d39525ee3cb48695fd94f0cea654d917363a5e0852e6d06175fb81ba5622cb7d4bd493ade4cdf8a3386c4cd2bec0e8b71de797fa76c22a7d5190168e8d9d9e13bc42e0994b1c1ddc1919dddc777f2d86e6cc0c354ebe6aba1d9876823137b64ff628030c4f9b533567adf6eec50ad3c2fc3aff402ec95a75fccb343fd413fbfd7ccc1bddd22a8f71690fca007716a7f8bc62ece210ffb308ddd78fa6268312ac1d9ec76d87954beba7d595692f9faff973e5d7ec545fddd1141660a58e4af82191ab38f8eef79359658cc91eb15c6af9cd600f9386486122a666ca80fd588290079a3028610cb20145d393016d00837c0d2b1d0291683a9c3b0ec50c4749247bbe295861f53bc0f01287cfef90a793a0c531ebb981a7aa4b4aefa68eefa597758da52f2eaafdcf46ddb1e17910bc528b65542e97808a49fd76783d21219c8db44d52b445198f98031f4a3a773a7f9ecc2a65908a808b7d0ed2a24de61cc4d0ca5aec2bd10a5a5b4827a77ebf6f2c4680af901cd3ffe82aeef0abb5487446bdb3005bc7419f624cd7061a03ca8583a07ba7f94fc54b85e9a1135f779e4f1dca87782953de0e38b2cc64808aa98566cb35a37e679368e407dc15b9ec85be4a4f9ee5929e90ac642e8685c9a4cff18b6a6dfd63ca41bac3c79d5f1e6a7e4f11c977b5d98fb4efaaf7a06f2ba10e45912bfbfc2dfe508ee7274489bf89bee6d0d44889035d68daf9d22b91bdfcf130eee44012e49909e3c7881f1339a3aaa4a0167477269b8bec7b0cb079d953c8d40185732cd42a133ef889be74522130f667771bc0d8a2de7ec6a5acdb640b695893e673cab5eec94538145122776c09aa20a9ab98c0d7a8e786154396d8ed6295e4af8fca0b90f4f75198ea95da06ce86e36ff4c126128da24b304d3d4fd5dab1602ad07269f73b79b62bc3a016db795ae287207f4e4efdc35af57f9bbb904ad0ab7693a66b4d563d92de034cccac0f9fb71238f6dc72381b8c6e753c9b0d57e82ae9f19d69c3ffe21be495288c8cdb5c3735791c51dae0aa292ec1e54f8596df604dc57aa9994d8484538c07bbb278af26dba6c30c094a4990c440395f73ea3708c1dc693d3a376a78d001270e57d478a28a6c8fda8422ec649fe333227ed94f6937ee1b83b44ba9f8dd17b9ce45a8564afb1b192da7e04e26ca41930ee2cf5a6d076767311a00cbb5666675a6a62ce3aa8971cb2dba274ec7d7615a4c43627d9487a9ec6e883f3e9a50de1bbe9c72ac2a53d1a1ee3fe170926434229eb45",
  "sig": "3ce107243deb12d4497a08a528dc45df5ef74f607deb19a10502fab121a88d49b346f0c719ec1023dd980d4f65e918b02e8a998b8e8a75e7a9b6d612de433b22c82c2bbf2d428cf7b8d923eaeb1442b3691231d3b89b02befda911e8e13294531cfed788291b6092227d0eecec864c246e645b4570759aa5013257dfccb6b9875909dc15e6b59f013819388e1f06738fbdc395e608a2e2046c0cb6dcc82c1acbee99d7701be6878edcc8763ab404c1d1d3ecd1feadb14a3dc3fbd2bf8f3fbc734b3da048c6b80c7793ae6ba09aa2f4b347791b55f93501753fadea88f9c734da5dea486d27ca0dc7e51e190c775c522e97d2f5a69d734be0b5f71e96cb145fe19fdf9240aeca18b0c5e05a4ba4eb75a1007bd3fdecb843f2e75fcda6fcebbd22131f11c264787a33a77c87b31551e8f85cce0f0c4786c5e86ee9c17cefdcf2e01c13fccff05b35265862abefc22806bcbfd397fcc35b808e177975d333876e220cf53c495a428b88df3d94c5d474e09a7596db4e200b3e7d33e9869c7a2e1a840ca5bdeff63230c9974126741f9b7b78e0c91aa32b431c3032b18751eca429606ad7b2a0dbd014da0101c28cd5442fa83d605844d29c2bda088096517d8e6ff88c1ef9576e1b36f04cb97c0edf5ebe025baad1891405ecb08a4720eb142479fa6ff506bd54d4ef0bbad0ee159ad80b3bb95bc11be2296ecd8eb0e1c1a104573588ac72f87c71e64c6028a759feabc7d7b55926de8db96742d0acd3bb438632cfdde3aaaf08fe60f6b7b9f17323a63c212cf3f7e96762175e7d4578c7bfacd3534082354e8ac1b16690dd022b000f21f28905d443d13d1b2ce34a07fe629e2e6236018feac6e599f519aad3b14e83557080d4b474fab17472f8da305045c38eadb3629e45e03f153b1b9947bcc28e1db759b49207856c9c64e07a323b468a8ded05e387887f202fa0cc2f12986aa961c827ab139175d9d3fdcc2f2550b5df2c70614d6b9bd2f41140ee7b5488ea5aed8ebf5288b49825e72983028c073aac4e1644472aead222294426d7927f81d0380b265b7e0549a051a55244a72ce3196f92c46ccbd5b6c59bbfe65f8c3812a261aac8ececbf38996d06c6bf3b0b8fc783659c356ddb003456e50b63856a0779907f9dc4af5fc1d31d1c530c745faca9de044e08e2b60102bc3ad97543f656817fa61871f3d8f6da7611449aa4cbd829a2fb6588796aec1706de5952c4aa389ed35e0d7c1f561294e76c43b0330ae3c2b65af08c46b2b0e2450b035bc30b4579b3f0318ed2550f8b54814c9e61b4a7f0d294732542b86c9f0a61f6bb3ec339d106c2b45d5ac045a6129ed8922c6e23c4a31b63aa602844bba6bd420100489f260c1103351475f58cef533c9b35242f09b00cd819dd92dc7979106e6b35f2f060e043942be4ca2512630b051fb96d49fdf6af31fac62f46f58068e756d620747f4345801217b1e611bcf26de24f44eb6793321cade79b5fc7c5e8f58cc9a6e32c942291f78091183a6ecceffc0450a40ee5697d5968206240d953ee8d22c8dc0e12e3b6cb280800ad848e0f6ff136c933588c27ee5cad2b94e795b96b5033c16448828b1d6a83d52ab8ba10e4b5387382685c2b4d486c56ca252144b08edf931a55d0f08586de5f0e762fa85c5453267175891af7cde9783ae034dd1e78bd4268ceef30ce0d2e6522f86c63ee2352c6e667720ad7dcdcce60d979e6e98a3107af1e9e4f2649821c7f3108727ffb79ce8b5c76f70ad5c1662485cbcd744851058e107a0ba75c9696c8f94256cc50b172c754b318b08a2b26752b9889107069f0cf9d6fec7351c17a2c180eb72bc558e3f8cadb7bc1fd55ff9174baee8b94158841c787e9d3add7aecd31d629e96af0a4ce036729b294054f61bd60468baf8bc47b8ead4999f9d8819ce80fc994bd37fe89aa056b7c20aa5dcfe9faf98b7fe3a449a377937a1a568167846c8319c91907bb4db5a19124ac128335bbd6ad79f08d47d363e81a489049e2ebf21ba7a5d54635e35ed6fa0db673e6373363b5be11fc9b8d54c0157c078b04907224d6daafaaa2da86d9e75341f560b36302983aefba478651a4f9c882e00b0abb942c46dcd0b0aba586f15b03c0aed3351b6f493305b2967c3ca07674773317e13c0dc0dfa83e7b560dc81c87693f4c8378f491d21b3fbd01d0df46b833d8ec27cf8ca3f1e1dc5a22bd170fdf001cd982725251e323bc3c93952ddf9fcca9331a1a52650531493bea85ea6520c6c69c3c42aa85c0c4dea7d9cf89767fd7b4b153222c9f3993c7d34f950cedd167d213ac39dc9cc910c3d41c22ac9ea64f06f1a5ae2b4442c0195f3f54c2e5db8a5e9046f01dae8ee50dc7a609e631a41152014c13f8e16e76087bffdb630d790ed5a3ba88580cf90a4605e99b3cb3a381c57e4a4de5e892dc393f1bc0eccef4b8036104875a43d6eda773334d19be164e84f7000ccdc6155573e343d77f498e2790d84f187770188abe9bd6395f6157aa5937ac6bcbf469b38d0d0e6bc7a0c434a64fd10811c3d016909637b9fd2475024af1bff65bb771173ccc2a39f971c6e5ca09967f6d60dba98d26ddc3e089e2940ca0dd8e46034cb5c82cc333b58241c86c1e81b60e53106a0244284752358b1d1413021ae425bbd780feacd2827589eff8004d00d1f68179509cda76e599f13296c5c771039765d4dd363627a1849d6dbe20a65361c71ac7149477b481d44387c67ad083f133cc29502b8f9e49e3485e8328e0277d0195522c5dc12eb0697382ec8f95852b0b42bed3f3f4bceab0ce56ee8ccd4de8b5dd608510162a4e58baa5ce09f2cf7b7c1c2324ba5d2c7b424a314a3a5bd7adb0dcc33212a1c6c75012c6fe11c03d82095c227c5b12990f332909309c9054ac31b2c3df87510ef5aa30fe1cc8270f9c792e1727e1864cd6a407ead21ce7d4773a90418cb2fbc787ebe1eb242dda2b8e71a1833793a16fd5d263ffe84880dec131bf821803baccfd812266387f3b6b3191b5016eb6effe70a64a46186ab9cf3d39a6db573fdabab37dd6b0cca20d38c88aba68d48c98b6327fb9dd32568124f0b5a3d0151c56009a758af56d07a39e1fe24c2a6240972b4779be4ef5702ca5f7f7f792b71caca9cd6d8de5d89ec10a270e06363722971e676043e8a3a9bab07c23c3d0fcaa98e10b4eef6bc9efa5c32ef381264177c39b2b56c89592b95ba3af92e8964681c33346e3174cec38bef75fdac65c5bb18e1ed541ac9d6c74a9d9875019c86dc95f46ad546b11bf27b6429eb3f248f2e5f10814173a69728389949798999aa6aeb8cfd7e6f2f40a233b3e4f55576e7f899d9ebadcf00b171b34464f55566c738d97a5b4b6c9ceea23565e6b6c889499abc1c3c6d7e3e5f0f500000000000000000015243647",
  "msg": "abcdef"
}
```